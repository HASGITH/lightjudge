import express from "express";
import cors from "cors";
import bodyParser from "body-parser";
import { dbInit, getUserByName, addUser, getTasks, addSubmission } from "./db.js";
import { judge } from "./judge.js";

const app = express();
app.use(cors());
app.use(bodyParser.json());

await dbInit();

app.get("/", (req, res) => res.send("LightJudge API Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚ âœ…"));

// Ð ÐµÐ³Ð¸ÑÑ‚Ñ€Ð°Ñ†Ð¸Ñ
app.post("/register", async (req, res) => {
  const { username, password } = req.body;
  await addUser(username, password);
  res.json({ ok: true });
});

// Ð’Ñ…Ð¾Ð´
app.post("/login", async (req, res) => {
  const { username, password } = req.body;
  const user = await getUserByName(username);
  if (!user || user.password !== password)
    return res.status(401).json({ error: "ÐÐµÐ²ÐµÑ€Ð½Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ" });
  res.json({ ok: true });
});

// Ð¡Ð¿Ð¸ÑÐ¾Ðº Ð·Ð°Ð´Ð°Ñ‡
app.get("/tasks", async (req, res) => {
  const tasks = await getTasks();
  res.json(tasks);
});

// ÐžÑ‚Ð¿Ñ€Ð°Ð²ÐºÐ° Ñ€ÐµÑˆÐµÐ½Ð¸Ñ
app.post("/submit", async (req, res) => {
  const { task_id, code } = req.body;
  const result = await judge(task_id, code);
  await addSubmission(task_id, result.score);
  res.json(result);
});

app.listen(4000, () => console.log("ðŸš€ Backend Ð½Ð° Ð¿Ð¾Ñ€Ñ‚Ñƒ 4000"));
